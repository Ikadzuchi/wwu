<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">

<html>
<head>
	<title>WentWayUp - JavaScript GIF Decoder</title>
</head>

<body>

<h1>JavaScript GIF Decoder</h1>
以前「GIFデコーダなんて2,3日もあればできる」と大見得を切ったので、週末を利用して作ってみた。<br />
実質2日でここまでできた。うん、大体予想通り。やっぱりGIFは簡単だ。<br />
ちなみにGIFは特許切れてるからこういうのを書いても大丈夫なはず。…はずだよね?<br />
<br />
◆解説<br />
確かめていませんがわりと任意のGIFを読み込んでくれるはずです。<br />
ただ、あまり大きなものはブラウザが固まるのでよした方がよいでしょう。<br />
具体的な使い方ですが、<br />
まず任意のGIF画像を用意します。縦横数十ドットくらいにしておきましょう。<br />
それをバイナリエディタで開き、16進ダンプします。<br />
そうしたらそれを、ここのURLの後ろに「?=」をつけて<br />
<a href="http://www.nexyzbb.ne.jp/~ikadzuchi/wwu/digital/soft/GifDec.html?=
4749463839611F001400F70000000000800000008000808000000080800080008080808080C0C0C0FF000000FF00FFFF000000FFFF00FF00FFFFFFFFFF0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000330000660000990000CC0000FF0033000033330033660033990033CC0033FF0066000066330066660066990066CC0066FF0099000099330099660099990099CC0099FF00CC0000CC3300CC6600CC9900CCCC00CCFF00FF0000FF3300FF6600FF9900FFCC00FFFF3300003300333300663300993300CC3300FF3333003333333333663333993333CC3333FF3366003366333366663366993366CC3366FF3399003399333399663399993399CC3399FF33CC0033CC3333CC6633CC9933CCCC33CCFF33FF0033FF3333FF6633FF9933FFCC33FFFF6600006600336600666600996600CC6600FF6633006633336633666633996633CC6633FF6666006666336666666666996666CC6666FF6699006699336699666699996699CC6699FF66CC0066CC3366CC6666CC9966CCCC66CCFF66FF0066FF3366FF6666FF9966FFCC66FFFF9900009900339900669900999900CC9900FF9933009933339933669933999933CC9933FF9966009966339966669966999966CC9966FF9999009999339999669999999999CC9999FF99CC0099CC3399CC6699CC9999CCCC99CCFF99FF0099FF3399FF6699FF9999FFCC99FFFFCC0000CC0033CC0066CC0099CC00CCCC00FFCC3300CC3333CC3366CC3399CC33CCCC33FFCC6600CC6633CC6666CC6699CC66CCCC66FFCC9900CC9933CC9966CC9999CC99CCCC99FFCCCC00CCCC33CCCC66CCCC99CCCCCCCCCCFFCCFF00CCFF33CCFF66CCFF99CCFFCCCCFFFFFF0000FF0033FF0066FF0099FF00CCFF00FFFF3300FF3333FF3366FF3399FF33CCFF33FFFF6600FF6633FF6666FF6699FF66CCFF66FFFF9900FF9933FF9966FF9999FF99CCFF99FFFFCC00FFCC33FFCC66FFCC99FFCCCCFFCCFFFFFF00FFFF33FFFF66FFFF99FFFFCCFFFFFF21F90401000010002C000000001F00140000085800FF091C48B0A0C18308132A5CC8B0A1C3870851A0103871A0C48315315EFC2731E346821D1756F4C8D162C886234F9EA4F870E24793165BB23448D2E1488E1B5F66B4A9B3E04E88317D024539B4A8D1A348932A5DAA3420003B">http://www.nexyzbb.ne.jp/~ikadzuchi/wwu/digital/soft//GifDec_pre.html?=
4749463839611F001400F70000000000800000008000808000000080800080008080808080C0C0C0FF000000FF00FFFF000000FFFF00FF00FFFFFFFFFF0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000330000660000990000CC0000FF0033000033330033660033990033CC0033FF0066000066330066660066990066CC0066FF0099000099330099660099990099CC0099FF00CC0000CC3300CC6600CC9900CCCC00CCFF00FF0000FF3300FF6600FF9900FFCC00FFFF3300003300333300663300993300CC3300FF3333003333333333663333993333CC3333FF3366003366333366663366993366CC3366FF3399003399333399663399993399CC3399FF33CC0033CC3333CC6633CC9933CCCC33CCFF33FF0033FF3333FF6633FF9933FFCC33FFFF6600006600336600666600996600CC6600FF6633006633336633666633996633CC6633FF6666006666336666666666996666CC6666FF6699006699336699666699996699CC6699FF66CC0066CC3366CC6666CC9966CCCC66CCFF66FF0066FF3366FF6666FF9966FFCC66FFFF9900009900339900669900999900CC9900FF9933009933339933669933999933CC9933FF9966009966339966669966999966CC9966FF9999009999339999669999999999CC9999FF99CC0099CC3399CC6699CC9999CCCC99CCFF99FF0099FF3399FF6699FF9999FFCC99FFFFCC0000CC0033CC0066CC0099CC00CCCC00FFCC3300CC3333CC3366CC3399CC33CCCC33FFCC6600CC6633CC6666CC6699CC66CCCC66FFCC9900CC9933CC9966CC9999CC99CCCC99FFCCCC00CCCC33CCCC66CCCC99CCCCCCCCCCFFCCFF00CCFF33CCFF66CCFF99CCFFCCCCFFFFFF0000FF0033FF0066FF0099FF00CCFF00FFFF3300FF3333FF3366FF3399FF33CCFF33FFFF6600FF6633FF6666FF6699FF66CCFF66FFFF9900FF9933FF9966FF9999FF99CCFF99FFFFCC00FFCC33FFCC66FFCC99FFCCCCFFCCFFFFFF00FFFF33FFFF66FFFF99FFFFCCFFFFFF21F90401000010002C000000001F00140000085800FF091C48B0A0C18308132A5CC8B0A1C3870851A0103871A0C48315315EFC2731E346821D1756F4C8D162C886234F9EA4F870E24793165BB23448D2E1488E1B5F66B4A9B3E04E88317D024539B4A8D1A348932A5DAA3420003B</a>
のように書き、リターンを押せば実行されます。<br />
何も入れないと、ソースに書いてあるテストデータ<br />
<img src="test2.gif" alt="テストデータ"><br />
を読み込みます。<br />

<br />


<script language="JavaScript"><!--
//JavaScript GIF Decoder
//Ver 1.0
//(c)2007 5/13 いかづちSqueak some rights reserved.
//無断使用・改変等歓迎。でもそんな大したものじゃないし、人の読めるようにコード書いてない。

function gifDecode(compData,LZHMin,clrTbl){
	decompData=new Array;
	dic=new Array;	//辞書。[0:開始位置,1:長さ]
	clear=Math.pow(2,LZHMin);
	end=clear+1;
	dicPtr=end+1;
	lastLen=0;
	lastPos=0;
	
	currSize=LZHMin+1;
	restBuf=currSize;
	consumedBits=0;
	buf=0;
	ptr=0;
	j=0;
	for(i=0;i<10000;i++){
		shift=8-restBuf;
		if(shift<0){
			shift=0;
		}
		buf+=( (compData[ptr]>>consumedBits) & (0xFF>>shift) )<<(currSize-restBuf);
		temp=consumedBits+restBuf;
		restBuf-=(8-consumedBits);
		if(restBuf<0){
			restBuf=0;
		}
		consumedBits=temp;
		if(consumedBits>8){
			consumedBits=0;
			ptr++;
		}
		if(restBuf==0){
			if (buf==clear){
				dicPtr=end+1;
				currSize=LZHMin+1;
			}
			else if (buf==end){
				break;
			}
			else if (buf<clear){
				if(j!=0){
					dic[dicPtr]=new Array;
					dic[dicPtr][0]=lastPos;
					dic[dicPtr][1]=lastLen+1;
					dicPtr++;
				}
				decompData[j]=buf;
				lastPos=j;
				lastLen=1;
				j++;
			}
			else if (buf>end){
				dic[dicPtr]=new Array;
				dic[dicPtr][0]=lastPos;
				dic[dicPtr][1]=lastLen+1;
				dicPtr++;
				for (k=0;k<dic[buf][1];k++){
					decompData[j+k]=decompData[dic[buf][0]+k];
				}
				lastPos=j;
				lastLen=dic[buf][1];
				j+=dic[buf][1];
			}

			if (dicPtr==Math.pow(2,currSize)){
				currSize++;
			}
			buf=0;
			restBuf=currSize;
		}
	}
	return decompData;
}


pxsize=2;

data=window.location.search;
data=data.substring(2,data.length);

if(data.length<2){
	document.write("No Data. Loaded Test Data.");
	document.write("<br />");
	data="47494638396148002700F70000000000800000008000808000000080800080008080808080C0C0C0FF000000FF00FFFF000000FFFF00FF00FFFFFFFFFF0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000330000660000990000CC0000FF0033000033330033660033990033CC0033FF0066000066330066660066990066CC0066FF0099000099330099660099990099CC0099FF00CC0000CC3300CC6600CC9900CCCC00CCFF00FF0000FF3300FF6600FF9900FFCC00FFFF3300003300333300663300993300CC3300FF3333003333333333663333993333CC3333FF3366003366333366663366993366CC3366FF3399003399333399663399993399CC3399FF33CC0033CC3333CC6633CC9933CCCC33CCFF33FF0033FF3333FF6633FF9933FFCC33FFFF6600006600336600666600996600CC6600FF6633006633336633666633996633CC6633FF6666006666336666666666996666CC6666FF6699006699336699666699996699CC6699FF66CC0066CC3366CC6666CC9966CCCC66CCFF66FF0066FF3366FF6666FF9966FFCC66FFFF9900009900339900669900999900CC9900FF9933009933339933669933999933CC9933FF9966009966339966669966999966CC9966FF9999009999339999669999999999CC9999FF99CC0099CC3399CC6699CC9999CCCC99CCFF99FF0099FF3399FF6699FF9999FFCC99FFFFCC0000CC0033CC0066CC0099CC00CCCC00FFCC3300CC3333CC3366CC3399CC33CCCC33FFCC6600CC6633CC6666CC6699CC66CCCC66FFCC9900CC9933CC9966CC9999CC99CCCC99FFCCCC00CCCC33CCCC66CCCC99CCCCCCCCCCFFCCFF00CCFF33CCFF66CCFF99CCFFCCCCFFFFFF0000FF0033FF0066FF0099FF00CCFF00FFFF3300FF3333FF3366FF3399FF33CCFF33FFFF6600FF6633FF6666FF6699FF66CCFF66FFFF9900FF9933FF9966FF9999FF99CCFF99FFFFCC00FFCC33FFCC66FFCC99FFCCCCFFCCFFFFFF00FFFF33FFFF66FFFF99FFFFCCFFFFFF2C00000000480027000008FF0013081C48B0A0400508132A44D8A0A1C387101F4E9A48B1A2C58B131718DC3870A14705114346C44892E4028D1C0502E8F8512144003001886C781140498C2751A65C99A0A5CB87321D061D79D3A24D8B3975725CE93361C4A1338BD6449A34A54A8431B1260C1A5368C898146D1E9D24162C599814939EB49A00C042B76EB1BE140AD36B03B213D186C59BB76F46B54A0D2A881B93F060BA75E7369069B4F1D8A34701AF35C874B065AD87B97A85CA756A45B17BF14A9E5C30AE65D37117DB55CDB9E163BF7B5F931D4D9AE060985BB3BA06DA7571EFBC7AF9C6363B690100DA829B829C1955EA67AAB4032B5FCE3CA4F3C669A3D7BE6D9A3BF7C4AE7B4BFFBC8EF1B876D297D35B56FD75F55DF2E5CF4F569F5E737BBBF0719A3FDF93BE42FB4F01751771678D55E067319D94A082C6E5B4556EA97125DE6E4209075968B2ED779C860AEEB7C083FF2D07A062AE15A89781B04196D38685319814885BD9059580348186DD737D35C8A0872E3A08237823D2C857861886D5E3862BF678D25B754928D38C881948E0943025D5A271552AF9A147D58994DF45F2D18604975D12F56576610286C4983F9539DE997FA5A9D69A6C32E4E69B70CAA9269D4EDDE95B6127020A9C595802CAE36874AE69A79FEF05079C518FF198A57C892ACA284D8F22086945804DAA5DA56B7669E87B998685E259715AE9A1A139811A2AA39B225D48A5A71D9EE7EAAB77D684A2A39C62A916AD7BDE2AAAA09A166BEA8A92AE0AE8AD74E65ADEAED022FBEBA1AD328B6B7525F16A687180764AED02D636DB259C68EA7952B8E232476EAAE6A29BAE97EB9A9B94BBEF9A99A7BCE7D2BB6640003B"}

ptr=12;
width=eval("0x"
	+data.substring(ptr+2,ptr+4)
	+data.substring(ptr,ptr+2)
);
ptr+=4;

height=eval("0x"
	+data.substring(ptr+2,ptr+4)
	+data.substring(ptr,ptr+2)
);
ptr+=4;

document.write("Width : "+width+" height : "+height);
document.write("<br />")

flags=eval("0x"+data.substring(ptr,ptr+2));
globalColor=flags & 0x80>>7;
colorRes=((flags & 0x70)>>4)+1;
sizeGCT=Math.pow(2,(flags & 0x7)+1);

document.write("flags:"+flags+" > globalcolor:" +globalColor+ " colorRes:" +colorRes+" size of GCT:"+ sizeGCT);
document.write("<br />Color Table:<br />");

ptr+=6;

clrTbl=new Array;
for (i=0;i<sizeGCT;i++){
	clrTbl[i]=new Array;
	for (j=0;j<3;j++){
		clrTbl[i][j]=data.substring(ptr,ptr+2);
		ptr+=2;
	}
	document.write("["+i+"]: "+clrTbl[i][0]+" "+clrTbl[i][1]+" "+clrTbl[i][2]+"<br>");
}

while(1){
	ext=eval("0x"+data.substring(ptr,ptr+2));
	ptr+=2;
	if (ext==0x2C){
		LPos=eval("0x"
			+data.substring(ptr+2,ptr+4)
			+data.substring(ptr,ptr+2)
		);
		ptr+=4;
		RPos=eval("0x"
			+data.substring(ptr+2,ptr+4)
			+data.substring(ptr,ptr+2)
		);
		ptr+=4;
		document.write("L Position:"+LPos+" R Position:"+RPos+"<br />");
		if (LPos+RPos>0){
			document.write("Local Position not supported.<br />");
		}
		localWd=eval("0x"
			+data.substring(ptr+2,ptr+4)
			+data.substring(ptr,ptr+2)
		);
		ptr+=4;
		localHt=eval("0x"
			+data.substring(ptr+2,ptr+4)
			+data.substring(ptr,ptr+2)
		);
		ptr+=4;
		document.write("Local Width:"+localWd+" Local Ht:"+localHt+"<br />");
		if ((width!=localWd) || (height!=localHt)){
			document.write("Local width/height not supported.<br />");
		}
		localFlags=eval("0x"+data.substring(ptr,ptr+2));
		ptr+=2;
		document.write("Local Flags:"+localFlags+" > ");
		localColor=localFlags & 0x80>>7;
		interlace=localFlags & 0x40>>6;
		sort=localFlags & 0x20>>5;
		sizeLCT=Math.pow(2,(localFlags & 0x7)+1);
		if (localColor==0){
			sizeLCT=0;
		}
		ptr+=sizeLCT;
		
		document.write("LocalColorTable:"+localColor+" Interlace:"+interlace+" sort:"+sort+" Size of LCT:"+sizeLCT+"<br />");
		if (localColor==1){
			document.write("Local color not supported.<br />");
		}
		if (interlace==1){
			document.write("Interlace not supported.<br />");
		}
		LZHMin=eval("0x"+data.substring(ptr,ptr+2));
		ptr+=2;
		document.write("LZH Minimum Code Size:"+LZHMin+"<br />");
		
		compData=new Array;
		dataSize=new Array;
		m=0;
		for (k=0;k<100000;k++){	//読み込むデータ量の最大値
			dataSize[k]=eval("0x"+data.substring(ptr,ptr+2));
			ptr+=2;
			if (dataSize[k]==0){
				break;
			}
			document.write("Image Data ["+k+"] / size:"+dataSize[k]+"<br />");
			for (l=0;l<dataSize[k];l++){
				compData[m]=eval("0x"+data.substring(ptr,ptr+2));
				ptr+=2;
				document.write(compData[m]+" ");
				m++;
			}
			document.write("<br />");
		}
		break;
	}
	else{
		blockSize=eval("0x"+data.substring(ptr+2,ptr+4));
		document.write(blockSize+"Byte non-graphic block.<br>");
		ptr+=4+blockSize*2+2;
	}
}

	decompData = gifDecode(compData,LZHMin,clrTbl);
	
	document.write("<br />Decompressed Data:");
	for(n=0;n<decompData.length;n++){
		if(n%width==0){
			document.write("<br />");
		}
		if(decompData[n]<100){
			document.write("0");
			if(decompData[n]<10){
				document.write("0");
			}
		}
		document.write(decompData[n]+"&nbsp;");
	}
	document.write("<br />Image:");
	for(n=0;n<decompData.length;n++){
		if(n%width==0){
			document.write("<br />");
		}
		document.write("<font color=\"#"+clrTbl[decompData[n]][0]+clrTbl[decompData[n]][1]+clrTbl[decompData[n]][2]+"\">■</font>");
	}

document.write("<br /><br />End.<br />");


/*

i=108;


document.write("<table cellpadding=\"0\" cellspacing=\"0\"><tr>");
while(i<(width*height*6)+108){

if(((i-108)/6)%width==0){
	document.write("</tr><tr height=\""+pxsize+">");
}

document.write("<td width=\"" + pxsize+"\" bgcolor=\"#");
document.write(data.substring(i+4,i+6));
document.write(data.substring(i+2,i+4));
document.write(data.substring(i,i+2));
document.write("\"></td>");
i+=6
}

document.write("</tr></table>");
*/
// --></script>



</body>
</html>

