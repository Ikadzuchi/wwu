<canvas id="cnv" width="640px" height="480px"></canvas><br>
<input type="button" onclick="exec()" value="exec"></input><br>
<span id="stdout"><br>




<script>

let imgdatdat;

	const WD = 640
	const HT = 480
	
	const vertlist=[
[-1.444891,2.086051,-0.212232],
[-2.340702,2.121262,-0.212232],
[-2.772071,1.731426,-0.212233],
[-2.544312,1.058531,-0.212233],
[-1.797529,0.759569,-0.212233],
[1.625830,1.004443,-0.527367],
[2.570767,1.240163,-0.381650],
[2.564251,2.075209,-0.250000],
[3.179868,2.493750,-0.306982],
[3.174138,2.491396,-0.226450],
[0.945755,2.531250,-0.945756],
[1.016466,2.531250,-1.016466],
[1.237437,1.952269,-1.237437],
[1.414213,1.138687,-1.414213],
[1.321586,0.456241,-1.321586],
[1.083989,0.134259,-1.083989],
[-0.000000,2.531250,-1.337500],
[-0.000001,2.531250,-1.437500],
[-0.000000,1.952269,-1.750000],
[0.000000,1.138687,-2.000000],
[0.000000,0.456241,-1.869005],
[0.000000,0.134259,-1.532992],
[-0.945756,2.531250,-0.945755],
[-1.016466,2.531250,-1.016466],
[-1.237437,1.952269,-1.237437],
[-1.414213,1.138687,-1.414213],
[-1.321586,0.456241,-1.321586],
[-1.083989,0.134259,-1.083989],
[-0.919239,2.550000,-0.919238],
[-0.000000,2.852473,-0.107843],
[-0.000000,2.643651,-0.400000],
[-0.000000,2.550000,-1.300000],
[-0.000001,3.112455,-0.316678],
[0.919238,2.550000,-0.919239],
[1.052921,-0.000000,-1.052921],
[-0.000000,-0.000000,-1.489055],
[-1.052921,0.000000,-1.052921],
[-1.820162,0.931696,0.000000],
[-0.107843,2.852473,0.000000],
[-1.600000,1.963515,0.000000],
[-2.312471,1.994693,0.000000],
[-1.500000,2.250000,0.000000],
[-2.475057,2.281178,0.000000],
[-2.632021,1.681820,0.000000],
[-3.000000,1.791919,0.000000],
[-1.444891,2.086051,0.212233],
[-2.340702,2.121262,0.212233],
[-2.772071,1.731426,0.212233],
[-2.438337,1.180896,0.000000],
[-2.650000,0.937500,0.000000],
[-1.841676,0.563046,0.000000],
[-2.544312,1.058531,0.212233],
[-1.797529,0.759569,0.212233],
[1.700000,1.425000,0.000000],
[2.282266,1.431236,0.000000],
[1.700000,0.600000,0.000000],
[2.838101,1.049484,0.000000],
[2.393535,2.206007,0.000000],
[2.671092,1.957867,0.000000],
[1.625830,1.004443,0.527367],
[2.570767,1.240162,0.381650],
[2.564251,2.075209,0.250000],
[2.800000,2.475000,0.000000],
[3.525000,2.493750,0.000000],
[2.900000,2.475000,0.000000],
[3.426088,2.491476,0.000000],
[3.179868,2.493750,0.306983],
[3.174138,2.491396,0.226451],
[0.000000,3.212394,0.000001],
[-0.400000,2.643651,0.000000],
[-1.300000,2.550000,0.000000],
[-0.316678,3.112455,0.000001],
[1.337500,2.531250,0.000000],
[1.437500,2.531250,0.000000],
[1.750000,1.952269,0.000000],
[2.000000,1.138687,0.000000],
[1.869005,0.456241,0.000000],
[1.532992,0.134259,0.000000],
[0.000000,0.000000,0.000000],
[1.489055,-0.000000,-0.000000],
[0.945755,2.531250,0.945756],
[1.016466,2.531250,1.016467],
[1.237437,1.952269,1.237438],
[1.414213,1.138687,1.414214],
[1.321586,0.456241,1.321586],
[1.083989,0.134259,1.083989],
[0.000000,0.000000,0.000000],
[-0.000000,2.531250,1.337501],
[-0.000001,2.531250,1.437501],
[-0.000000,1.952269,1.750001],
[0.000000,1.138687,2.000000],
[0.000000,0.456241,1.869005],
[0.000000,0.134258,1.532992],
[0.000000,0.000000,0.000000],
[-0.945756,2.531250,0.945756],
[-1.016466,2.531250,1.016467],
[-1.237437,1.952269,1.237437],
[-1.414213,1.138687,1.414214],
[-1.321586,0.456241,1.321586],
[-1.083989,0.134259,1.083989],
[0.000000,0.000000,0.000000],
[-1.337500,2.531250,0.000000],
[-1.437500,2.531250,0.000000],
[-1.750000,1.952269,0.000000],
[-2.000000,1.138687,0.000000],
[-1.869005,0.456241,0.000000],
[-1.532992,0.134259,0.000000],
[0.000000,0.000000,0.000000],
[-0.919239,2.549999,0.919239],
[-0.000000,2.852473,0.107844],
[-0.000001,3.212394,0.000001],
[-0.000000,2.643651,0.400001],
[-0.000000,2.549999,1.300001],
[-0.000001,3.112455,0.316679],
[0.919238,2.549999,0.919240],
[0.107843,2.852473,0.000000],
[0.000000,3.212394,0.000001],
[0.400000,2.643651,0.000000],
[1.300000,2.550000,0.000000],
[0.316678,3.112455,0.000001],
[1.052921,-0.000000,1.052921],
[-0.000000,-0.000001,1.489055],
[-1.052921,-0.000000,1.052921],
[-1.489055,0.000000,0.000000],
	];
	const vnlist=[
	
[-0.4282,0.6470,-0.6309],
[-0.0336,-0.8547,-0.5180],
[0.5920,-0.6551,-0.4694],
[-0.6927,-0.2838,-0.6631],
[0.0312,0.7949,-0.6059],
[0.8299,0.2809,-0.4820],
[-0.4780,0.5290,-0.7012],
[0.3026,0.7558,-0.5807],
[0.2978,-0.7541,-0.5854],
[0.0000,0.9981,0.0610],
[0.8439,0.1552,-0.5136],
[-0.0084,0.7824,-0.6227],
[-0.7712,0.0933,-0.6297],
[0.4431,-0.7237,-0.5291],
[-0.0230,0.9994,0.0258],
[0.8888,0.2731,-0.3681],
[0.0000,1.0000,0.0000],
[0.9097,-0.1746,-0.3768],
[0.3425,0.4463,-0.8268],
[0.6651,-0.6941,-0.2755],
[0.3681,0.2731,-0.8888],
[0.2755,-0.6941,-0.6651],
[-0.3425,0.4463,-0.8268],
[-0.3681,0.2731,-0.8888],
[0.3768,-0.1746,-0.9097],
[-0.8888,0.2731,-0.3681],
[-0.3768,-0.1746,-0.9097],
[-0.8268,0.4463,-0.3425],
[-0.2755,-0.6941,-0.6651],
[-0.9097,-0.1746,-0.3768],
[-0.2882,0.9132,-0.2882],
[-0.6651,-0.6941,-0.2755],
[0.5027,0.7033,-0.5027],
[-0.6148,-0.4939,-0.6148],
[0.1034,0.9937,-0.0428],
[0.0000,0.9536,-0.3010],
[0.6148,-0.4939,-0.6148],
[-0.0648,0.9958,-0.0648],
[0.0648,0.9958,-0.0648],
[0.8268,0.4463,-0.3425],
[0.8843,-0.2894,-0.3663],
[0.3663,-0.2894,-0.8843],
[-0.3663,-0.2894,-0.8843],
[-0.8843,-0.2894,-0.3663],
[0.0000,-1.0000,0.0000],
[-0.5027,0.7033,-0.5027],
[0.0428,0.9937,-0.1034],
[-0.0428,0.9937,-0.1034],
[-0.1034,0.9937,-0.0428],
[-0.3400,-0.7340,-0.5879],
[-0.4961,0.6515,0.5740],
[-0.0336,-0.8547,0.5180],
[0.5923,-0.6049,0.5322],
[-0.7925,-0.2683,0.5476],
[0.0312,0.7949,0.6059],
[0.7736,0.2991,0.5587],
[-0.4780,0.5290,0.7012],
[0.3032,0.7522,0.5851],
[0.2791,-0.7426,0.6088],
[0.0000,0.9981,-0.0610],
[0.8439,0.1552,0.5136],
[-0.0084,0.7824,0.6227],
[-0.7918,0.1137,0.6002],
[0.4563,-0.7271,0.5130],
[-0.0230,0.9994,-0.0258],
[0.8888,0.2731,0.3681],
[0.9097,-0.1746,0.3768],
[0.3425,0.4463,0.8268],
[0.6651,-0.6941,0.2755],
[0.3681,0.2731,0.8888],
[0.2755,-0.6941,0.6651],
[-0.3425,0.4463,0.8268],
[-0.3681,0.2731,0.8888],
[0.3768,-0.1746,0.9097],
[-0.8888,0.2731,0.3681],
[-0.3768,-0.1746,0.9097],
[-0.8268,0.4463,0.3425],
[-0.2755,-0.6941,0.6651],
[-0.9097,-0.1746,0.3768],
[0.0000,-0.9536,-0.3010],
[-0.6651,-0.6941,0.2755],
[0.5027,0.7033,0.5027],
[-0.6148,-0.4939,0.6148],
[0.1034,0.9937,0.0428],
[0.0000,0.9536,0.3010],
[0.6148,-0.4939,0.6148],
[-0.0648,0.9958,0.0648],
[0.0648,0.9958,0.0648],
[0.8268,0.4463,0.3425],
[0.8843,-0.2894,0.3663],
[0.3663,-0.2894,0.8843],
[-0.3663,-0.2894,0.8843],
[-0.8843,-0.2894,0.3663],
[-0.5027,0.7033,0.5027],
[0.0428,0.9937,0.1034],
[-0.0428,0.9937,0.1034],
[-0.1034,0.9937,0.0428],
[-0.3400,-0.7340,0.5879],
[-0.4961,0.6515,-0.5740],
[-0.0377,-0.8605,-0.5081],
[0.5923,-0.6049,-0.5322],
[-0.7925,-0.2683,-0.5476],
[0.0258,0.8062,-0.5911],
[0.7736,0.2991,-0.5587],
[-0.4966,0.5328,-0.6852],
[0.3032,0.7522,-0.5851],
[0.2791,-0.7426,-0.6088],
[-0.0379,0.9989,0.0265],
[0.9283,0.0650,-0.3662],
[-0.1302,0.8437,-0.5208],
[-0.7918,0.1137,-0.6002],
[0.4563,-0.7271,-0.5130],
[-0.0250,0.9993,0.0274],
[0.0000,-0.9536,0.3010],
[-0.6149,-0.4939,-0.6148],
[0.2882,0.9132,-0.2882],
[0.6149,-0.4939,-0.6148],
[-0.2712,-0.6775,-0.6837],
[-0.4282,0.6470,0.6309],
[-0.0377,-0.8605,0.5081],
[0.5920,-0.6551,0.4694],
[-0.6927,-0.2838,0.6631],
[0.0258,0.8062,0.5911],
[0.8299,0.2809,0.4820],
[-0.4966,0.5328,0.6852],
[0.3026,0.7558,0.5807],
[0.2978,-0.7541,0.5854],
[-0.0379,0.9989,-0.0265],
[0.9283,0.0650,0.3662],
[-0.1302,0.8437,0.5208],
[-0.7712,0.0933,0.6297],
[0.4431,-0.7237,0.5291],
[-0.0250,0.9993,-0.0274],
[-0.2882,0.9132,0.2882],
[0.2882,0.9132,0.2882],
[-0.2712,-0.6775,0.6837],
	];
	const trilist=[[63,8,58, 1],
[40,2,1, 2],
[41,3,2, 3],
[3,50,45, 4],
[2,42,1, 5],
[44,4,3, 6],
[3,43,2, 7],
[4,38,5, 8],
[56,7,57, 9],
[65,9,63, 10],
[7,59,57, 11],
[55,6,54, 12],
[55,8,7, 13],
[9,59,8, 14],
[9,66,64, 15],
[75,14,13, 16],
[74,11,73, 17],
[77,14,76, 18],
[19,12,13, 19],
[78,15,77, 20],
[13,20,19, 21],
[15,22,21, 22],
[18,25,24, 23],
[19,26,25, 24],
[11,18,17, 17],
[15,20,14, 25],
[26,104,25, 26],
[18,23,17, 17],
[21,26,20, 27],
[25,103,24, 28],
[22,27,21, 29],
[23,103,102, 17],
[26,106,105, 30],
[69,33,72, 31],
[28,106,27, 32],
[116,31,30, 33],
[72,30,39, 34],
[34,118,119, 35],
[117,33,111, 36],
[120,30,33, 37],
[31,29,70, 38],
[118,34,31, 39],
[75,12,74, 40],
[16,80,35, 41],
[16,36,22, 42],
[28,36,37, 43],
[28,124,107, 44],
[79,124,37, 45],
[37,36,79, 45],
[79,36,35, 45],
[35,80,79, 45],
[30,70,39, 46],
[34,32,31, 47],
[29,31,32, 48],
[29,71,70, 49],
[4,51,50, 50],
[63,62,67, 51],
[47,40,46, 52],
[41,48,44, 53],
[48,50,52, 54],
[42,47,46, 55],
[44,52,49, 56],
[43,48,47, 57],
[52,38,49, 58],
[56,61,60, 59],
[67,65,63, 60],
[59,61,57, 61],
[60,55,54, 62],
[55,62,58, 63],
[67,59,64, 64],
[66,67,64, 65],
[75,84,76, 66],
[81,74,73, 17],
[84,77,76, 67],
[82,90,83, 68],
[85,78,77, 69],
[83,91,84, 70],
[85,93,86, 71],
[89,97,90, 72],
[90,98,91, 73],
[88,82,81, 17],
[91,85,84, 74],
[97,105,98, 75],
[88,96,89, 17],
[98,92,91, 76],
[96,104,97, 77],
[99,93,92, 78],
[95,103,96, 17],
[98,106,99, 79],
[69,114,111, 80],
[106,100,99, 81],
[112,116,110, 82],
[110,72,39, 83],
[115,119,118, 84],
[114,117,111, 85],
[110,120,114, 86],
[112,70,109, 87],
[118,112,115, 88],
[82,75,74, 89],
[121,78,86, 90],
[122,86,93, 91],
[123,93,100, 92],
[124,100,107, 93],
[79,123,124, 45],
[123,79,122, 45],
[79,121,122, 45],
[121,79,80, 45],
[70,110,39, 94],
[115,112,113, 95],
[109,113,112, 96],
[109,70,71, 97],
[51,52,50, 98],
[63,9,8, 99],
[40,41,2, 100],
[41,44,3, 101],
[3,4,50, 102],
[2,43,42, 103],
[44,49,4, 104],
[3,45,43, 105],
[4,49,38, 106],
[56,6,7, 107],
[65,10,9, 108],
[7,8,59, 109],
[55,7,6, 110],
[55,58,8, 111],
[9,64,59, 112],
[9,10,66, 113],
[75,76,14, 16],
[74,12,11, 17],
[77,15,14, 18],
[19,18,12, 19],
[78,16,15, 20],
[13,14,20, 21],
[15,16,22, 22],
[18,19,25, 23],
[19,20,26, 24],
[11,12,18, 17],
[15,21,20, 25],
[26,105,104, 26],
[18,24,23, 17],
[21,27,26, 27],
[25,104,103, 28],
[22,28,27, 29],
[23,24,103, 17],
[26,27,106, 30],
[69,111,33, 114],
[28,107,106, 32],
[116,118,31, 33],
[72,33,30, 115],
[117,120,33, 116],
[120,116,30, 117],
[75,13,12, 40],
[16,78,80, 41],
[16,35,36, 42],
[28,22,36, 43],
[28,37,124, 44],
[30,31,70, 46],
[4,5,51, 118],
[63,58,62, 119],
[47,41,40, 120],
[41,47,48, 121],
[48,45,50, 122],
[42,43,47, 123],
[44,48,52, 124],
[43,45,48, 125],
[52,53,38, 126],
[56,57,61, 127],
[67,68,65, 128],
[59,62,61, 129],
[60,61,55, 130],
[55,61,62, 131],
[67,62,59, 132],
[66,68,67, 133],
[75,83,84, 66],
[81,82,74, 17],
[84,85,77, 67],
[82,89,90, 68],
[85,86,78, 69],
[83,90,91, 70],
[85,92,93, 71],
[89,96,97, 72],
[90,97,98, 73],
[88,89,82, 17],
[91,92,85, 74],
[97,104,105, 75],
[88,95,96, 17],
[98,99,92, 76],
[96,103,104, 77],
[99,100,93, 78],
[95,102,103, 17],
[98,105,106, 79],
[69,72,114, 134],
[106,107,100, 81],
[112,118,116, 82],
[110,114,72, 83],
[114,120,117, 135],
[110,116,120, 86],
[82,83,75, 89],
[121,80,78, 90],
[122,121,86, 91],
[123,122,93, 92],
[124,123,100, 93],
[70,112,110, 94],
[51,53,52, 136],
	]
	
function exec()
{
	var ctx = document.getElementById("cnv").getContext("2d");
	var imgdat = ctx.getImageData(0, 0, WD, HT);
	imgdatdat = imgdat.data;
	
	let str = "";
	
/*
	line(100,100,120,140,40);
	line(101,101,121,61,40);
	line(102,102,142,122,40);
	line(103,103,63,123,40);
	line(100,100,80,140,40);
	line(101,101,81,61,40);
	line(102,102,142,82,40);
	line(103,103,63,83,40);
	*/
	
	let tempmat = [
		1, 0, 0,
		0, 0.86, -0.5,
		0, 0.5, 0.86,
	]
	let tempmat2 = [
		0.86, 0, -0.5,
		0, 1, 0,
		0.5, 0, 0.86,
	]
	let rotmat = matxmat(tempmat, tempmat2);
	
	let scrvertlist = [];
	for(let i=0; i<vertlist.length; i++)
	{
		scrvertlist[i] = matxvec(rotmat, vertlist[i]);
	}
	
	for(let i=0; i<scrvertlist.length; i++)
	{
		scrvertlist[i][0] /= -scrvertlist[i][2]+15;
		scrvertlist[i][1] /= -scrvertlist[i][2]+15;
		scrvertlist[i][0] *= 15;
		scrvertlist[i][1] *= 15;
	}

	let n=0;
	let max=-1000000;
	let min= 1000000;
	const mult = 60;
	const offsy = 240;
	const offsx = 320;
	
	let cullcnt0=0;
	let cullcnt1=0;
	let cullcnt2=0;
	let cullcnt3=0;

	for(let i=0; i<trilist.length; i++)
	{
		let v0x = -scrvertlist[trilist[i][0]-1][0]*mult+offsx;
		let v0y = -scrvertlist[trilist[i][0]-1][1]*mult+offsy;
		let v1x = -scrvertlist[trilist[i][1]-1][0]*mult+offsx;
		let v1y = -scrvertlist[trilist[i][1]-1][1]*mult+offsy;
		let v2x = -scrvertlist[trilist[i][2]-1][0]*mult+offsx;
		let v2y = -scrvertlist[trilist[i][2]-1][1]*mult+offsy;
		
		
		let vn = vnlist[trilist[i][3]-1];
		let scrvn = matxvec(rotmat,vn);
		let light = (scrvn[0]+scrvn[1]+scrvn[2])/1.73;
		/*
		if(light<0)light=0; //ランバート
		*/
		light = ((light+1)/2)
		light *= light; //ハーフランバート
		
		color = Math.round(light*255);
		
		let wind;
		let xordiff = (v1x-v0x)^(v2y-v0y)^(v2x-v0x)^(v1y-v0y);
		if((xordiff&0x80000000) != 0)
		{
			cullcnt2+=1;
			wind = ((v1x-v0x)^(v2y-v0y)) & 0x80000000;
			if(wind != 0)
			{
				cullcnt3++;
				continue;
			}
		}
		else
		{
			wind = ((v1x-v0x)*(v2y-v0y) - (v2x-v0x)*(v1y-v0y));
			cullcnt0+=1;
			if(wind < 0)
			{
				cullcnt1++;
				continue;
			}
		}
		
		let tx;
		let ty;
		let lx;
		let ly;
		let rx;
		let ry;
		if(v0y<=v1y)
		{
			if(v0y<=v2y)
			{
				tx = v0x;
				ty = v0y;
				lx = v2x;
				ly = v2y;
				rx = v1x;
				ry = v1y;
			}
			else
			{
				tx = v2x;
				ty = v2y;
				lx = v1x;
				ly = v1y;
				rx = v0x;
				ry = v0y;
			}
		}
		else
		{
			if(v1y<=v2y)
			{
				tx = v1x;
				ty = v1y;
				lx = v0x;
				ly = v0y;
				rx = v2x;
				ry = v2y;
			}
			else
			{
				tx = v2x;
				ty = v2y;
				lx = v1x;
				ly = v1y;
				rx = v0x;
				ry = v0y;
			}
		}
		filltri(
			Math.round(tx),
			Math.round(ty),
			Math.round(lx),
			Math.round(ly),
			Math.round(rx),
			Math.round(ry),
			color);
		
	//	line (v0x, v0y, v1x, v1y, 0);
	//	line (v1x, v1y, v2x, v2y, 0);
	//	line (v2x, v2y, v0x, v0y, 0);
		n++;
		if(max<v0x) max=v0y;
		if(min>v0x) min=v0y;
	}
	
	//filltri(200,45, 104,278, 409,169 , 64);
	//filltri(200,45, 224,278, 409,169 , 64);
	//filltri(200,45, 420,278, 409,169 , 64);
	//hline(104, 309, 278, 128);
	
	ctx.putImageData(imgdat, 0, 0);

	document.getElementById("stdout").innerHTML += str + imgdatdat[7] +","+ imgdatdat[4] + " cull:" +cullcnt0+","+cullcnt1+","+cullcnt2+","+cullcnt3+" "+mat2str(matxmat(tempmat,tempmat)) + "," + ((1^13^-1^31)&0x80000000).toString(16);
}



for(x=0; x<12; x+=0.1)
{
	for(y=0; y<12; y+=0.1)
	{
		
	}
}

function filltri(tx, ty, lx, ly, rx, ry, color)//top x, y, left.. right.. ; top = 最上(タイ含む)
{
	//color = Math.floor(Math.random()*255);
	testdiff = 0;
	//line (tx, ty, lx, ly, color);
	//line (tx, ty, rx, ry, color);
	
	let dxl = Math.abs(lx-tx);
	let lsign = lx-tx>0? 1: -1;
	let dyl = ly-ty;
	let dxr = Math.abs(rx-tx);
	let rsign = rx-tx>0? 1: -1;
	let dyr = ry-ty;
	let dxlr = Math.abs(rx-lx);
	let lrsign = rx-lx>0? -1: 1;
	let dylr = Math.abs(ry-ly);
	
	let accl = dyl/2
	let accr = dyr/2
	let il = tx;
	let ir = tx;
	let iy = ty;
	if(ly > ry) //右の方が上
	{
		while(iy < ry)
		//ty==lyのとき1回も走らない
		//最下段は塗らない
		{
			accl-=dxl;
			while(accl<0){
				accl+=dyl;
				il+=lsign;
			}

			accr-=dxr
			while(accr<0){
				accr+=dyr
				ir+=rsign;
			}
			hline(il,ir,iy,color) //右端は塗らない
			iy++;
		}
		
		//右端をアップデート
		accr = dylr/2
		ir = rx;
		if (ly==ry)
		{
			il = lx;
			//hline ? 最下段だから塗らない?
		}
		else
		{
			while(iy <= ly) //最下段は塗らない?→否
			{
				accl-=dxl;
				while(accl<0){
					accl+=dyl;
					il+=lsign;
				}

				accr -= dxlr
				while(accr<0){
					accr+=dylr
					ir+=lrsign;
				}
				
				hline(il,ir,iy,color+testdiff)
				iy++
			}
		}
	}
	else
	{
		while(iy < ly)
		{
			accl-=dxl;
			while(accl<0){
				accl+=dyl;
				il+=lsign;
			}

			accr-=dxr
			while(accr<0){
				accr+=dyr
				ir+=rsign;
			}
			hline(il,ir,iy,color) //右端は塗らない
			iy++;
		}
		
		//左端をアップデート
		accl = dylr/2
		il = lx;
		if (ly==ry)
		{
			ir = rx;
			//hline ...
		}
		else
		{
			while(iy <= ry) //最下段は塗らない?→否
			{
				accr-=dxr;
				while(accr<0){
					accr+=dyr;
					ir+=rsign;
				}

				accl -= dxlr
				while(accl<0){
					accl+=dylr
					il-=lrsign;
				}
				
				hline(il,ir,iy,color+testdiff)
				iy++
			}
		}
	}



}

function hline(xl,xr,y,color)
{
	//if(xl>xr)return
	for(let ix=xl; ix<xr; ix++)
	{
		putpx(ix,y,color);
	}
}
function matxvec(mat, vec)
{
	return [
		mat[0]*vec[0] + mat[1]*vec[1] + mat[2]*vec[2],
		mat[3]*vec[0] + mat[4]*vec[1] + mat[5]*vec[2],
		mat[6]*vec[0] + mat[7]*vec[1] + mat[8]*vec[2],
	]
}

function matxmat(ma, mb)
{
	return [
		ma[0]*mb[0] + ma[1]*mb[3] + ma[2]*mb[6],
		ma[0]*mb[1] + ma[1]*mb[4] + ma[2]*mb[7],
		ma[0]*mb[2] + ma[1]*mb[5] + ma[2]*mb[8],
		ma[3]*mb[0] + ma[4]*mb[3] + ma[5]*mb[6],
		ma[3]*mb[1] + ma[4]*mb[4] + ma[5]*mb[7],
		ma[3]*mb[2] + ma[4]*mb[5] + ma[5]*mb[8],
		ma[6]*mb[0] + ma[7]*mb[3] + ma[8]*mb[6],
		ma[6]*mb[1] + ma[7]*mb[4] + ma[8]*mb[7],
		ma[6]*mb[2] + ma[7]*mb[5] + ma[8]*mb[8],
	]
}

function mat2str(mat)
{
	return "<table>"+
		"<tr><td>| "+mat[0]+"</td><td>| "+mat[1]+"</td><td>| "+mat[2]+"</td></tr>"+
		"<tr><td>| "+mat[3]+"</td><td>| "+mat[4]+"</td><td>| "+mat[5]+"</td></tr>"+
		"<tr><td>| "+mat[6]+"</td><td>| "+mat[7]+"</td><td>| "+mat[8]+"</td></tr>"+
		"</table>"
}

function line(x1,y1,x2,y2,color)
{
	let dx = Math.round(x2)-Math.round(x1);
	let dy = Math.round(y2)-Math.round(y1);
	let sgnx = (dx>0)? 1: -1;
	let sgny = (dy>0)? 1: -1;
	let absx = Math.abs(dx);
	let absy = Math.abs(dy);
	if(Math.abs(dx)>Math.abs(dy))
	{
		//横
		let acc = Math.round(absx/2);
		let ix = Math.round(x1);
		let iy = Math.round(y1);
		let i=0;
		while(i<absx)
		{
			putpx(ix,iy,color);
			acc-=absy;
			if(acc<0)
			{
				iy+=sgny;
				acc+=absx
			}
			ix+=sgnx;
			i++;
		}
	}
	else
	{
		//縦
		let acc = Math.round(absy/2);
		let ix = Math.round(x1);
		let iy = Math.round(y1);
		let i=0;
		while(i<absy)
		{
			putpx(ix,iy,color);
			acc-=absx;
			if(acc<0)
			{
				ix+=sgnx;
				acc+=absy
			}
			iy+=sgny;
			i++;
		}
	}
	/*
	putpx(x1,y1,color);
	putpx(x2,y2,color);
	for(let i=1;i<99;i++)
	{
		putpx(x1+Math.round(dx/100*i),y1+Math.round(dy/100*i),color);
	}
	*/
	
}

function putpx(x,y,color)
{
	imgdatdat[(WD*y+x)*4  ] = imgdatdat[(WD*y+x)*4  ]==0?color:color/2+128;
	imgdatdat[(WD*y+x)*4+1] = color;
	imgdatdat[(WD*y+x)*4+2] = color;
	imgdatdat[(WD*y+x)*4+3] = 255;
}
</script>